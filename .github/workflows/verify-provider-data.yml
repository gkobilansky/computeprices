name: Verify Provider Data

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Specific provider slug to verify (leave empty for auto-rotation)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  verify-provider:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine provider to verify
        id: provider
        env:
          PROVIDER_INPUT: ${{ github.event.inputs.provider }}
        run: |
          if [ -n "$PROVIDER_INPUT" ]; then
            # Validate provider slug format (lowercase alphanumeric with hyphens only)
            if ! echo "$PROVIDER_INPUT" | grep -qE '^[a-z0-9-]+$'; then
              echo "Error: Invalid provider slug format. Must be lowercase alphanumeric with hyphens only."
              exit 1
            fi
            echo "slug=$PROVIDER_INPUT" >> $GITHUB_OUTPUT
          else
            # Auto-rotate: pick provider based on week number
            WEEK=$(date +%V)
            PROVIDERS=$(ls data/providers/*.json | xargs -n1 basename | sed 's/.json//' | sort)
            PROVIDER_COUNT=$(echo "$PROVIDERS" | wc -l)
            INDEX=$((WEEK % PROVIDER_COUNT))
            PROVIDER=$(echo "$PROVIDERS" | sed -n "$((INDEX + 1))p")
            echo "slug=$PROVIDER" >> $GITHUB_OUTPUT
            echo "Auto-selected provider for week $WEEK: $PROVIDER"
          fi

      - name: Verify provider file exists
        env:
          PROVIDER_SLUG: ${{ steps.provider.outputs.slug }}
        run: |
          if [ ! -f "data/providers/${PROVIDER_SLUG}.json" ]; then
            echo "Error: Provider file not found: data/providers/${PROVIDER_SLUG}.json"
            exit 1
          fi

      - name: Run Claude Code verification
        id: claude
        env:
          PROVIDER_SLUG: ${{ steps.provider.outputs.slug }}
        uses: anthropics/claude-code-action@beta
        with:
          mode: agent
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: Read,Edit,Glob,Grep,WebSearch,WebFetch
          direct_prompt: |
            Verify and update provider data for: ${{ env.PROVIDER_SLUG }}

            ## CRITICAL: This is a WEB RESEARCH Task

            Your PRIMARY objective is to research the provider's current state using web sources.
            You MUST use WebSearch and WebFetch tools extensively.
            DO NOT use bash, curl, or codebase analysis as a substitute for web research.

            ## Step 1: WEB RESEARCH FIRST (Required)

            Before reading any files, perform comprehensive web research:

            1. **Use WebSearch to find:**
               - "${{ env.PROVIDER_SLUG }} GPU cloud 2025 2026"
               - "${{ env.PROVIDER_SLUG }} pricing changes"
               - "${{ env.PROVIDER_SLUG }} new features announcement"
               - "${{ env.PROVIDER_SLUG }} company news"
               - "${{ env.PROVIDER_SLUG }} data centers regions"

            2. **Use WebFetch to visit and analyze these pages:**
               - Provider's main website homepage
               - Pricing page (look for /pricing, /plans)
               - Documentation site (look for /docs, /documentation)
               - Features/products page
               - About/company page (for HQ location, company info)
               - Blog or news section (for recent updates)

            3. **Gather specific information:**
               - Current GPU models offered (H100, H200, A100, etc.)
               - Geographic regions and data center locations
               - Pricing models (on-demand, reserved, spot, etc.)
               - Key features and differentiators
               - Recent product launches or changes
               - Company positioning and tagline
               - Support options

            ## Step 2: Read Current Provider Data

            After completing web research, read these files:
            1. Read: data/providers/PROVIDER_DATA_GUIDELINES.md
            2. Read: data/providers/${{ env.PROVIDER_SLUG }}.json

            ## Step 3: Compare and Identify Discrepancies

            Compare what you found in web research (Step 1) with the current JSON data (Step 2).

            Look for:
            - Outdated GPU model listings
            - Incorrect or broken URLs
            - Missing new features or services
            - Changed company information (name, tagline, location)
            - Inaccurate descriptions
            - Missing fields recommended by guidelines
            - Outdated pros/cons that no longer apply

            ## Step 4: Update Provider File (If Needed)

            If you found discrepancies:
            - Use Edit tool to update data/providers/${{ env.PROVIDER_SLUG }}.json
            - Be conservative - only change what's clearly wrong or outdated
            - Add missing recommended fields from guidelines
            - Preserve JSON formatting (2-space indent)
            - Follow PROVIDER_DATA_GUIDELINES.md content standards

            If data is accurate: Make no changes

            ## Step 5: Provide Detailed Summary

            Output a comprehensive summary including:
            - **Web sources checked:** List all URLs you visited with WebFetch
            - **Web searches performed:** List all search queries you used
            - **What you verified as accurate:** Specific claims you confirmed
            - **What you changed and why:** Each change with supporting web source
            - **Confidence level:** High/Medium/Low with justification

            ## FORBIDDEN ACTIONS

            DO NOT:
            - Use bash commands to fetch web content (curl, wget, etc.)
            - Use grep/git to analyze the codebase instead of web research
            - Skip web research and only look at existing data
            - Use Task tool or sub-agents (do the research yourself)
            - Guess or infer information without web sources

            You MUST perform actual web research using WebSearch and WebFetch.
            Your summary MUST include the web sources you checked.

            ## Important Constraints
            - Do NOT change the provider's UUID (id field)
            - Do NOT change the slug
            - Preserve JSON formatting (2-space indent)
            - Only make factual corrections backed by web sources
            - Follow PROVIDER_DATA_GUIDELINES.md for content standards

      - name: Check for changes
        id: changes
        env:
          PROVIDER_SLUG: ${{ steps.provider.outputs.slug }}
        run: |
          if git diff --quiet "data/providers/${PROVIDER_SLUG}.json"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected for ${PROVIDER_SLUG}"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected for ${PROVIDER_SLUG}"
            git diff "data/providers/${PROVIDER_SLUG}.json"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          PROVIDER_SLUG: ${{ steps.provider.outputs.slug }}
          CLAUDE_CONCLUSION: ${{ steps.claude.outputs.conclusion }}
        # Pinned to v6 SHA for supply chain security
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update provider data for ${{ env.PROVIDER_SLUG }}"
          title: "Update provider data: ${{ env.PROVIDER_SLUG }}"
          body: |
            ## Provider Data Update

            This PR was automatically generated by the weekly provider verification workflow.

            **Provider:** ${{ env.PROVIDER_SLUG }}

            ### Changes

            Please review the changes to `data/providers/${{ env.PROVIDER_SLUG }}.json` below.

            ### Verification Summary

            ${{ env.CLAUDE_CONCLUSION || 'See workflow logs for details.' }}

            ---

            **Note:** The database will be automatically synced when this PR is merged to main via the `sync-providers.yml` workflow.

            *This PR was created automatically by Claude Code. Please review the changes carefully before merging.*
          branch: update-provider-${{ env.PROVIDER_SLUG }}
          delete-branch: true
          labels: |
            automated
            provider-data
